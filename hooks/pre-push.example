#!/bin/bash
#
# Client-side git pre-push hook for documentation generation
# Generates HTML docs BEFORE pushing to ensure docs are current
#
# Installation:
#   1. Copy this file to .git/hooks/pre-push
#   2. Make it executable: chmod +x .git/hooks/pre-push
#   3. Adjust paths below to match your setup
#
# This hook runs BEFORE you push, so you can commit the generated docs

# Configuration
SOLUTION_FILE="CSharpCallGraphAnalyzer.sln"
HTML_OUTPUT_DIR="docs/html"
ANALYZER_PATH="./CSharpCallGraphAnalyzer/bin/Release/net8.0/csharp-analyzer"
AUTO_COMMIT_DOCS=true  # Set to false to just generate without committing

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}[Pre-Push Hook] Generating HTML documentation...${NC}"

# Check if analyzer exists
if [ ! -f "$ANALYZER_PATH" ]; then
    echo "Warning: Analyzer not found. Build with: dotnet build -c Release"
    exit 0  # Don't block the push
fi

# Generate HTML documentation
$ANALYZER_PATH analyze \
    --solution "$SOLUTION_FILE" \
    --format html \
    --output "$HTML_OUTPUT_DIR" \
    2>&1 | grep -E "(✓|Error|Warning)"

if [ $? -eq 0 ] || [ $? -eq 1 ]; then
    echo -e "${GREEN}✓ HTML documentation generated${NC}"

    # Check if docs changed
    if [ "$AUTO_COMMIT_DOCS" = true ]; then
        if ! git diff --quiet "$HTML_OUTPUT_DIR"; then
            echo "Documentation has changes, adding to commit..."
            git add "$HTML_OUTPUT_DIR"
            git commit -m "Update HTML documentation [auto-generated]" --no-verify
            echo -e "${GREEN}✓ Documentation committed${NC}"
        else
            echo "Documentation unchanged, no commit needed"
        fi
    fi
else
    echo "Warning: Documentation generation failed (non-critical)"
fi

exit 0  # Always exit 0 so push continues
